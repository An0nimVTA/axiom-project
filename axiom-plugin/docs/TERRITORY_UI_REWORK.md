# Territory UI Rework

## Goal
Сделать визуализацию территорий в UI‑моде понятной и быстрой: квадраты по чанкам, централизованная модель на сервере и стабильная синхронизация на клиент.

## Scope
- Источник данных: серверная модель территорий (TerritoryService).
- Экспорт и карты: MapBoundaryService + WebExportService.
- UI‑мод: отображение чанков как квадратов на карте.
- Протокол: пакетная синхронизация по каналу `axiom:ui`.

## Server Model
- Территория хранится на сервере по ключу `world:x:z`.
- Владелец один на чанк.
- Любой повторный claim переносит владение, предыдущий владелец очищается.
- Unclaim не может удалить чужое владение.

## Data Contract
Рекомендуемый формат полезной нагрузки (JSON):
- `type`: `territory`
- `world`: имя мира
- `chunks`: список записей
- `chunks[].x`: координата чанка X
- `chunks[].z`: координата чанка Z
- `chunks[].ownerId`: идентификатор владельца (nation id)
- `chunks[].ownerName`: отображаемое имя владельца
- `chunks[].color`: цвет границы/заливки (ARGB)

## Server Sync
- На событие изменения территории сервер отправляет дельту.
- При входе клиента сервер отправляет полный снимок.
- Дельты и полный снимок используют один и тот же формат `type=territory`.

## Client UI
- Рендеринг квадратов по чанкам на карте.
- Цвет задаётся по owner (цвет нации).
- Опционально: заливка с низкой прозрачностью + контур.
- При наведении: подсказка с владельцем и координатами чанка.

## Rendering Rules
- Базовый размер квадрата: 16x16 блоков на карте, масштабируется как карта.
- Рендер только видимой области для производительности.
- Для большого количества чанков использовать батч‑рендер.

## Performance
- Кэшировать модель на клиенте и обновлять дельтами.
- Ограничить частоту отправки дельт (например 1 раз в 200–400 мс).
- Для массовых изменений использовать пакет «bulk update».

## Config
- Включить/выключить слой территорий.
- Непрозрачность заливки и толщина линий.
- Фильтр по нациям.

## Tests
- Unit: TerritoryService инварианты.
- Integration: MapBoundaryService обновляет модель после claim/unclaim/war.
- UI smoke: проверка, что слой появляется и обновляется.

## Notes
- Поддерживать совместимость с WebExportService (данные одинакового формата).
- При миграции старых данных предусмотреть конвертацию ключей чанков.

---

## Snapshot + Delta Protocol (axiom:ui)

### Client Requests
- `get_territories_snapshot` — полный снапшот территорий.
- `get_territories_delta` + `long sinceVersion` — дельта изменений.

### Server Responses
- `territories_snapshot`:
  - `version` (long)
  - `territories` (array): `{world,x,z,nationId}`
- `territories_delta`:
  - `version` (long)
  - `changes` (array): `{op,world,x,z,nationId}` где `op=claim|unclaim`

### Behavior
- Если клиент запрашивает дельту старше чем хранится в журнале, сервер отвечает снапшотом.
- Версия увеличивается на каждый `claim/unclaim`.

---

## UI Cache + Batch Render

### Cache
- UI держит индекс чанков по ключу `world:x:z` + `territoryVersion`.
- При снапшоте/дельте увеличивается `territoryRevision`.
- Экран карты пересобирает батч только если изменились параметры (zoom/offset/bounds) или `territoryRevision`.

### Batch Render
- На основе текущих параметров строится список `RenderTile` (экранные координаты, размер, цвет).
- На каждом кадре отрисовываются только подготовленные `RenderTile` без перерасчёта координат.
